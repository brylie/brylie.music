---
import { type CollectionEntry, getCollection, render } from 'astro:content';
import BlogPost from '../../layouts/BlogPost.astro';
import { SEOHelper } from '../../utils/seo';

export async function getStaticPaths() {
	const posts = await getCollection('blog');
	return posts.map((post) => ({
		params: { slug: post.id },
		props: post,
	}));
}
type Props = CollectionEntry<'blog'>;

const post = Astro.props;
const { Content } = await render(post);

// Generate BlogPosting structured data
const postUrl = new URL(`/blog/${post.id}`, Astro.site).toString();

// Ensure required date fields exist
if (!post.data.datePublished) {
	throw new Error(`Blog post ${post.id} is missing required datePublished field`);
}

const structuredData = {
	'@context': 'https://schema.org',
	'@type': 'BlogPosting',
	headline: post.data.title,
	description: post.data.description,
	author: post.data.author ? {
		'@type': 'Person',
		name: post.data.author
	} : undefined,
	datePublished: post.data.datePublished.toISOString(),
	dateModified: (post.data.dateModified || post.data.datePublished).toISOString(),
	url: postUrl,
	image: post.data.heroImage ? new URL(post.data.heroImage.src, Astro.site).toString() : undefined,
	keywords: post.data.keywords?.join(', '),
	mainEntityOfPage: {
		'@type': 'WebPage',
		'@id': postUrl
	}
};
---

<BlogPost {...post.data} structuredData={structuredData}>
	<Content />
</BlogPost>
